name: Release - MVP

on:
  push:
    tags:
      - 'mvp-v*'

permissions:
  contents: write

jobs:
  release-mvp:
    strategy:
      matrix:
        include:
          - runtime: win-x64
            self_contained: true
            runner: windows-latest
          - runtime: linux-x64
            self_contained: true
            runner: ubuntu-latest
          - runtime: osx-x64
            self_contained: true
            runner: macos-latest
    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Parse version (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $TAG = "${env:GITHUB_REF}" -replace '^refs/tags/', ''
          $VERSION = $TAG -replace '^mvp-v', ''
          Write-Host "VERSION=$VERSION"
          Write-Host "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Parse version (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=$(echo $TAG | sed -E 's/mvp-v(.*)/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Publish AkkaSync.Host
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
              pwsh -Command 'dotnet publish src/AkkaSync.Host/AkkaSync.Host.csproj -c Release -r osx-x64 --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=false -o ./publish/AkkaSync.Host'
          else
              dotnet publish src/AkkaSync.Host/AkkaSync.Host.csproj \
                -c Release \
                -r ${{ matrix.runtime }} \
                --self-contained ${{ matrix.self_contained }} \
                -p:PublishSingleFile=true \
                -p:PublishTrimmed=false \
                -o ./publish/AkkaSync.Host
          fi

      - name: Build Dashboard
        run: |
          cd dashboard
          npm install
          npm run build
          npm run export
          mkdir -p ../publish/release/dashboard
          cp -r out/* ../publish/release/dashboard/

      - name: Add run scripts
        run: |
          if [ "${{ matrix.runtime }}" = "win-x64" ]; then
              echo "AkkaSync.Host\\AkkaSync.Host.exe" > publish/release/run.bat
          else
              echo "dotnet AkkaSync.Host/AkkaSync.Host.dll" > publish/release/run.sh
              chmod +x publish/release/run.sh
          fi
        
      - name: Zip MVP
        id: zip
        run: |
          ZIP_NAME="AkkaSync.MVP-${VERSION}-${{ matrix.runtime }}.zip"
          cd publish
          zip -r ../$ZIP_NAME *
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.zip.outputs.zip_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}