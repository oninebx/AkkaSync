name: Release - MVP

on:
  push:
    tags:
      - 'mvp-v*'

permissions:
  contents: write

jobs:
  release-mvp:
    strategy:
      matrix:
        include:
          - runtime: win-x64
            self_contained: true
            runner: windows-latest
          - runtime: linux-x64
            self_contained: true
            runner: ubuntu-latest
          - runtime: osx-x64
            self_contained: true
            runner: macos-latest
    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Parse version (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $TAG = "${env:GITHUB_REF}" -replace '^refs/tags/', ''
          $VERSION = $TAG -replace '^mvp-v', ''
          Write-Host "VERSION=$VERSION"
          Write-Host "VERSION=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Parse version (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=$(echo $TAG | sed -E 's/mvp-v(.*)/\1/')
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Publish AkkaSync.Host
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "Windows" ]]; then
              pwsh -Command 'dotnet publish src/AkkaSync.Host/AkkaSync.Host.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=false -o ./release/AkkaSync.Host'
          else
              dotnet publish src/AkkaSync.Host/AkkaSync.Host.csproj \
                -c Release \
                -r ${{ matrix.runtime }} \
                --self-contained ${{ matrix.self_contained }} \
                -p:PublishSingleFile=true \
                -p:PublishTrimmed=false \
                -o ./release/AkkaSync.Host
          fi

      - name: Build Dashboard
        run: |
          cd dashboard
          npm install
          npm run build
          mkdir -p ../release/dashboard
          cp -r out/* ../release/dashboard/
        env:
          MVP_BUILD: true

      - name: Add run scripts
        shell: bash
        run: |
          mkdir -p release

          if [[ "${{ matrix.runtime }}" == "win-x64" ]]; then
            # Windows batch script
            cat << 'EOF' > release/run.bat
          @echo off
          cd /d %~dp0
          start "" AkkaSync.Host\AkkaSync.Host.exe
          timeout /t 2 /nobreak >nul
          start "" "http://localhost:5000"
          pause
          EOF

          elif [[ "${{ matrix.runtime }}" == osx-* ]]; then
            # macOS command script
            cat << 'EOF' > release/run.command
          #!/bin/bash
          cd "$(dirname "$0")"
          ./AkkaSync.Host/AkkaSync.Host &
          sleep 2
          open "http://localhost:5000"
          wait
          EOF
            chmod +x release/run.command

          else
            # Linux shell script
            cat << 'EOF' > release/run.sh
          #!/usr/bin/env bash
          cd "$(dirname "$0")"
          ./AkkaSync.Host/AkkaSync.Host &
          sleep 2
          xdg-open "http://localhost:5000"
          wait
          EOF
            chmod +x release/run.sh
          fi

      - name: Zip MVP
        shell: bash
        id: zip
        run: |
          ZIP_NAME="AkkaSync.MVP-${VERSION}-${{ matrix.runtime }}.zip"
          if [[ "${{ runner.os }}" == "Windows" ]]; then
              pwsh -Command "Compress-Archive -Path release\* -DestinationPath $ZIP_NAME -Force"
          else
              cd release
              zip -r ../$ZIP_NAME *
          fi
          echo "zip_name=$ZIP_NAME" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ steps.zip.outputs.zip_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}